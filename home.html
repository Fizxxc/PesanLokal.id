<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PesanLokal - Beranda</title>
  <link rel="stylesheet" href="/css/style.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.lordicon.com/lordicon.js"></script>
  <style>
/* === BASE === */
body {
  font-family: 'Inter', sans-serif;
  margin: 0;
  background: #f9fafb;
  color: #1f2937;
  overflow-x: hidden;
}

/* === HEADER === */
.header-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: linear-gradient(90deg, #4f46e5, #6366f1);
  color: white;
  padding: 1rem 2rem;
  position: sticky;
  top: 0;
  z-index: 1000;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.user-info {
  display: flex;
  align-items: center;
  gap: 0.8rem;
}
.user-info img {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  border: 2px solid #ffffff80;
  object-fit: cover;
  transition: transform 0.3s ease;
}
.user-info img:hover { transform: scale(1.07); }

/* === BUTTONS === */
#authBtn {
  background: #fff;
  color: #4f46e5;
  border: none;
  padding: 0.6rem 1.2rem;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: 0.25s;
}
#authBtn:hover { background: #f3f4f6; }

/* === NOTIF === */
.notif-icon img {
  width: 28px;
  height: 28px;
  filter: brightness(0) invert(1);
  cursor: pointer;
  transition: 0.2s;
}
.notif-icon img:hover { transform: scale(1.1); }
.badge {
  position: absolute;
  top: 0;
  right: 0;
  background: #ef4444;
  color: white;
  font-size: 0.7rem;
  border-radius: 50%;
  padding: 2px 5px;
}

/* === NOTIF PANEL === */
.notif-panel {
  position: fixed;
  top: 80px;
  right: 20px;
  width: 320px;
  max-height: 400px;
  overflow-y: auto;
  background: #fff;
  border-radius: 14px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.15);
  padding: 1rem;
  display: none;
  animation: fadeIn 0.3s ease;
}
.notif-item {
  background: #f9fafb;
  border-left: 4px solid #4f46e5;
  padding: 0.8rem;
  border-radius: 8px;
  margin-bottom: 0.6rem;
  color: #374151;
  cursor: pointer;
  transition: 0.2s;
}
.notif-item:hover { background: #eef2ff; }

/* === HERO === */
#welcome {
  text-align: center;
  background: url('https://images.unsplash.com/photo-1556745757-8d76bdb6984b?auto=format&fit=crop&w=1920&q=80') center/cover no-repeat;
  padding: 3rem 1.5rem;
  color: white;
  border-bottom-left-radius: 40px;
  border-bottom-right-radius: 40px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.1);
}
#welcome h2 { font-size: 2rem; font-weight: 700; }

/* === PRODUCT LIST === */
.product-list {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 1.5rem;
  padding: 2rem;
  max-width: 1200px;
  margin: auto;
}
.product-card {
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.06);
  overflow: hidden;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.product-card:hover { transform: translateY(-5px); box-shadow: 0 12px 25px rgba(0,0,0,0.12); }
.product-card h3, .product-card p { text-align: center; }

/* === LIVE CHAT === */
#chatButton {
  position: fixed;
  bottom: 20px;
  right: 90px;
  background: white;
  border: none;
  border-radius: 50%;
  width: 70px;
  height: 70px;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(0,0,0,0.25);
  transition: transform 0.3s ease;
  z-index: 9999;
  display: flex;
  justify-content: center;
  align-items: center;
}
#chatButton:hover { transform: scale(1.1); }

#chatBox {
  position: fixed;
  bottom: 100px;
  right: 20px;
  width: 340px;
  height: 420px;
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.15);
  display: none;
  flex-direction: column;
  overflow: hidden;
  z-index: 10000;
}
.chat-header {
  background: linear-gradient(90deg, #4f46e5, #6366f1);
  color: white;
  padding: 0.9rem;
  font-weight: 600;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.chat-messages {
  flex: 1;
  padding: 1rem;
  overflow-y: auto;
  background: #f9fafb;
}
.message {
  max-width: 80%;
  margin-bottom: 10px;
  padding: 0.7rem;
  border-radius: 12px;
  font-size: 0.9rem;
  line-height: 1.4;
}
.bot { background: #eef2ff; align-self: flex-start; }
.user { background: #4f46e5; color: white; align-self: flex-end; }
.chat-input {
  display: flex;
  border-top: 1px solid #e5e7eb;
}
.chat-input input {
  flex: 1;
  border: none;
  padding: 0.8rem;
  font-size: 0.9rem;
  outline: none;
}
.chat-input button {
  background: #4f46e5;
  border: none;
  color: white;
  padding: 0 1rem;
  cursor: pointer;
}

/* === MUSIC BUTTON === */
#musicControl {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #4f46e5;
  color: white;
  border-radius: 50%;
  width: 55px;
  height: 55px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.3rem;
  cursor: pointer;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  transition: 0.3s;
}
#musicControl:hover { transform: scale(1.1); }

/* === ANIMATIONS === */
@keyframes fadeIn { from { opacity: 0; transform: translateY(-10px);} to { opacity: 1; transform: translateY(0);} }
  </style>
</head>

<body>
  <!-- HEADER -->
  <div class="header-top">
    <div class="user-info">
      <img id="userPhoto" src="/assets/default-user.png" alt="User Photo" />
      <div>
        <div>Hi, <span id="userName">Pengguna</span></div>
        <div id="userEmail" style="font-size:0.85rem;">Selamat datang!</div>
      </div>
    </div>
    <div style="display:flex; align-items:center; gap:1rem; position:relative;">
      <button id="authBtn"></button>
      <div class="notif-icon" id="notifToggle">
        <img src="/assets/bell.png" alt="Notifikasi">
        <span class="badge" id="notifBadge" style="display:none;">!</span>
      </div>
    </div>
  </div>

  <!-- NOTIF PANEL -->
  <div class="notif-panel" id="notifPanel"></div>

  <!-- HERO -->
  <section id="welcome">
    <h2>Selamat Datang di PesanLokal!</h2>
    <p>Pilih dan pesan produk lokal favoritmu dengan mudah.</p>
  </section>

  <div id="productList" class="product-list"></div>

  <!-- LIVE CHAT BUTTON (LORDICON) -->
  <button id="chatButton" title="Chat dengan PsL Service">
    <lord-icon
      src="https://cdn.lordicon.com/jdgfsfzr.json"
      trigger="hover"
      style="width:55px;height:55px">
    </lord-icon>
  </button>

  <!-- LIVE CHAT BOX -->
  <div id="chatBox">
    <div class="chat-header">PsL Service <span style="cursor:pointer;" id="closeChat">‚úñ</span></div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input">
      <input id="chatInput" placeholder="Ketik pesan..." />
      <button id="sendChat">‚û§</button>
    </div>
  </div>

  <!-- MUSIC -->
  <div id="musicControl" title="Klik untuk pause/resume üéµ">üéµ</div>

  <!-- FOOTER -->
  <footer style="text-align:center; padding:1rem; background:#1e1b4b; color:white;">
    &copy; 2025 PesanLokal.id ‚Äî Powered by DigiCraft
  </footer>

  <script type="module">
    import { auth, db } from '/firebase.js';
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const authBtn=document.getElementById('authBtn'),
          userPhoto=document.getElementById('userPhoto'),
          userName=document.getElementById('userName'),
          userEmail=document.getElementById('userEmail'),
          notifPanel=document.getElementById('notifPanel'),
          notifBadge=document.getElementById('notifBadge'),
          notifToggle=document.getElementById('notifToggle'),
          chatButton=document.getElementById('chatButton'),
          chatBox=document.getElementById('chatBox'),
          closeChat=document.getElementById('closeChat'),
          chatMessages=document.getElementById('chatMessages'),
          chatInput=document.getElementById('chatInput'),
          sendChat=document.getElementById('sendChat'),
          productList=document.getElementById('productList'),
          musicControl=document.getElementById('musicControl');

    let currentUser=null;
    const products=[{name:"Es Teh",price:3000},{name:"Cilor",price:"2000 - 10000"},{name:"Mie Goreng",price:6000},{name:"Mie Kuah",price:6000}];
    const botResponses={
      "halo":"Hai! üëã Ada yang bisa saya bantu?",
      "harga":"Kamu bisa lihat harga di daftar produk ya üòä",
      "buka":"Kami buka setiap hari jam 08.00 - 22.00 üïó",
      "pesan":"Silakan pilih produk lalu tekan tombol 'Pesan' üí¨",
      "admin":"Tunggu sebentar, admin akan segera menghubungimu üîî",
      "terimakasih":"Sama-sama! üòä",
      "thank":"Sama-sama! üòä",
      "promo":"Lihat promo terbaru di dashboard atau tanya admin ya üéÅ"
    };

    function renderProducts(){
      productList.innerHTML="";
      products.forEach(p=>{
        const card=document.createElement('div');
        card.className='product-card';
        card.innerHTML=`<h3>${p.name}</h3><p>Rp ${p.price}</p><button onclick="Swal.fire('Pesanan','Silakan login untuk memesan','info')">Pesan</button>`;
        productList.appendChild(card);
      });
    }
    renderProducts();

    notifToggle.onclick=()=>{notifPanel.style.display=notifPanel.style.display==="none"?"block":"none"};
    notifPanel.onclick=()=>{notifPanel.style.display="none";notifBadge.style.display="none";};

    async function loadNotifications(){
      const snap=await getDocs(collection(db,"notifications"));
      notifPanel.innerHTML="";
      if(!snap.empty) notifBadge.style.display="inline-block";
      snap.forEach(docSnap=>{
        const div=document.createElement('div');
        div.className='notif-item';
        div.textContent=docSnap.data().text;
        div.onclick=()=>{div.remove(); if(notifPanel.childElementCount===0) notifBadge.style.display="none";};
        notifPanel.appendChild(div);
      });
    }

    onAuthStateChanged(auth,user=>{
      currentUser=user;
      if(user){
        userName.textContent=user.displayName||"Pengguna";
        userEmail.textContent=user.email;
        authBtn.innerText="Logout";
        authBtn.onclick=()=>signOut(auth);
        loadNotifications();
      } else {
        userName.textContent="Pengguna";
        userEmail.textContent="Silakan login terlebih dahulu";
        authBtn.innerText="Login";
        authBtn.onclick=()=>location.href="/login";
      }
    });

    /* === Chat === */
    chatButton.onclick=()=>chatBox.style.display="flex";
    closeChat.onclick=()=>chatBox.style.display="none";
    sendChat.onclick=sendMessage;
    chatInput.addEventListener("keypress",e=>{if(e.key==="Enter")sendMessage()});

    function appendMessage(sender,text){
      const msg=document.createElement('div');
      msg.className=`message ${sender}`;
      msg.textContent=text;
      chatMessages.appendChild(msg);
      chatMessages.scrollTop=chatMessages.scrollHeight;
    }

    async function sendMessage(){
      const text=chatInput.value.trim().toLowerCase();
      if(!text) return;
      appendMessage("user",text);
      chatInput.value="";
      const response=Object.keys(botResponses).find(k=>text.includes(k));
      setTimeout(()=>{
        appendMessage("bot",response?botResponses[response]:"Maaf, saya belum paham. Ketik 'admin' jika butuh bantuan langsung üôè");
      },600);
      if(currentUser){
        await addDoc(collection(db,"chat_logs"),{uid:currentUser.uid,message:text,from:"user",timestamp:Date.now()});
      }
    }

    /* === MUSIC === */
    const musicList=["/assets/music/track1.mp3","/assets/music/track2.mp3"];
    const audio=new Audio(musicList[Math.floor(Math.random()*musicList.length)]);
    audio.loop=true; audio.volume=0.5;
    window.addEventListener("load",()=>audio.play().catch(()=>{}));
    let isPlay=true;
    musicControl.onclick=()=>{if(isPlay){audio.pause();musicControl.textContent="‚è∏Ô∏è"}else{audio.play();musicControl.textContent="üéµ"}isPlay=!isPlay;}
  </script>
</body>
</html>
